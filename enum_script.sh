#!/bin/bash

#enumeration script.  Need to add header
#need to check that program is installed before execution
#if nse ourt returns nothing, scrap it 
#update nse database before start

read -p "Enter the IP address you would like to enumerate: " ipaddr 
#need to perform error checking 

outfile=${ipaddr}_enumeration.txt

echo "Beggining enumeration on $ipaddr..."

echo "Performing nmap OS and version detection, script scanning, and traceroute"

echo "==========================================" > $outfile
echo "=              NMAP Ouput                =" >> $outfile
echo "=========================================="\n\n >> $outfile

nmap -A -T4 $ipaddr >> $outfile

#==============================================
#========NSE HTTP Vulnerability Testing========
#==============================================

http_vuln_scripts="$(ls /usr/share/nmap/scripts/*vuln* | grep http | cut -d '/' -f6)"
http_open_test="$(cat $outfile | grep '80/tcp' | grep -c 'open')"

if [ $http_open_test > 0 ]; then
     echo "TCP port 80 is open.  Testing for vulnerabilites with nse scripts"
     for script in $http_vuln_scripts
     do
       echo "Testing for $script"
       echo "=========================================================" >> $outfile
       echo "=                          $script                      =" >> $outfile
       echo "=========================================================" >> $outfile
       nmap -v -p 80 --script=$script $ipaddr >> $outfile
     done
fi	


#==============================================
#===============SMB Enumeration================
#==============================================

smb_vuln_scripts="$(ls /usr/share/nmap/scripts/*vuln* | grep smb | cut -d '/' -f6)"
smb_open_test="$(cat $outfile | grep -E '139/tcp|445/tcp' | grep -c 'open')"

if [ $smb_open_test > 0 ]; then
     echo "TCP port 139/445 is open.  Testing for vulnerabilites with nse scripts"
     for script in $smb_vuln_scripts
     do
       echo "Testing for $script"
       echo "=========================================================" >> $outfile
       echo "=                          $script                      =" >> $outfile
       echo "=========================================================" >> $outfile
       nmap -v -p 139,445 --script=$script $ipaddr >> $outfile
     done
     echo "Identifying NetBIOS information with nbtscan"
     echo "==========================================" >> $outfile
     echo "=                nbtscan                 =" >> $outfile
     echo "==========================================" >> $outfile
     nbtscan $ipaddr >> $outfile
     echo "Performing null session enumeration with enum4linux"
     echo "==========================================" >> $outfile
     echo "=                enum4linux              =" >> $outfile
     echo "==========================================" >> $outfile
     enum4linux -a $ipaddr >> $outfile
fi
#==============================================
#========NSE MYSQL Vulnerability Testing=======
#==============================================

#==============================================
#========NSE RDP Vulnerability Testing=========
#==============================================

#==============================================
#========NSE Samba Vulnerability Testing=======
#==============================================

#==============================================
#=========NSE FTP Vulnerability Testing========
#==============================================

ftp_vuln_scripts="$(ls /usr/share/nmap/scripts/*vuln* | grep ftp | cut -d '/' -f6)"
ftp_open_test="$(cat $outfile | grep 21/tcp | grep -c 'open')"

if [ $ftp_open_test > 0 ]; then
     echo "TCP port 21 is open.  Testing for vulnerabilites with nse scripts"
     for script in $ftp_vuln_scripts
     do
       echo "Testing for $script"
       echo "=========================================================" >> $outfile
       echo "=                          $script                      =" >> $outfile
       echo "=========================================================" >> $outfile
       nmap -v -p 21 --script=$script $ipaddr >> $outfile
     done
fi

#==============================================
#=================theHarvester=================
#==============================================

echo "Harvesting emails with theHarvester"

theharvester -d $ipadder -b google >> $outfile
#-d domain 
#-b will search Google email addresses associated with that domain

echo "Enumeration compelte.  Data saved to ${ipaddr}_enumeration.txt" 

exit
